<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Dashboard</title>
  
  <!-- Tailwind CSS from CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Inter font for clean typography -->
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background-color: #f1f5f9;
    }
  </style>

  <!-- React libraries from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- Babel for in-browser JSX compilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Recharts for powerful charting -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/dist/recharts.min.js"></script>
</head>
<body>
  <!-- The root element where the React app will be mounted -->
  <div id="root"></div>

  <!-- The React application code with JSX, transpiled by Babel -->
  <script type="text/babel">
    // This script will run once the DOM is fully loaded, ensuring all libraries are available.
    document.addEventListener('DOMContentLoaded', () => {
      const { useState, useEffect } = React;
      const Recharts = window.Recharts;

      if (!Recharts) {
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<div className="flex items-center justify-center min-h-screen text-red-600">Error: Recharts library could not be loaded. Check your internet connection.</div>);
        return;
      }
      
      const { 
        LineChart, Line, BarChart, Bar, PieChart, Pie, Cell,
        XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
      } = Recharts;

      // --- Configuration ---
      // NOTE: Replace these URLs with the "Published to the web" gviz/tq links from your Google Sheets.
      // You will need to publish each tab of your Google Sheet individually.
      // The URL format should be:
      // https://docs.google.com/spreadsheets/d/e/SHEET_ID/gviz/tq?tqx=out:json&gid=GID
      const summaryUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1sKRkps4JP6pkMiZV1R516l1n9zB1mo8mJax7ZzNXyMUhUzJiMInJn8s-gVb-MCy-O37kZmV0EU8H/gviz/tq?gid=767051025&headers=1&tqx=out:json';
      const weeklySalesUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1sKRkps4JP6pkMiZV1R516l1n9zB1mo8mJax7ZzNXyMUhUzJiMInJn8s-gVb-MCy-O37kZmV0EU8H/gviz/tq?gid=598028268&headers=1&tqx=out:json';
      const demoTrendsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1sKRkps4JP6pkMiZV1R516l1n9zB1mo8mJax7ZzNXyMUhUzJiMInJn8s-gVb-MCy-O37kZmV0EU8H/gviz/tq?gid=432130342&headers=1&tqx=out:json';
      const pipelineUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1sKRkps4JP6pkMiZV1R516l1n9zB1mo8mJax7ZzNXyMUhUzJiMInJn8s-gVb-MCy-O37kZmV0EU8H/gviz/tq?gid=1956557586&headers=1&tqx=out:json';

      // Helper function to fetch and parse data from the gviz/tq endpoint
      const fetchAndParseSheetData = async (url) => {
        try {
          console.log(`Attempting to fetch data from: ${url}`);
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const text = await response.text();
          console.log('Raw response text:', text);

          // Use regex to extract the JSON string from the gviz/tq response
          const jsonMatch = text.match(/(?<=\().*(?=\);)/s);
          console.log('Regex match result:', jsonMatch);

          if (!jsonMatch) {
            throw new Error("Invalid response format. Please ensure the sheet is published and the URL is correct.");
          }
          
          const jsonString = jsonMatch[0];
          console.log('Extracted JSON string:', jsonString);

          const parsedData = JSON.parse(jsonString);
          console.log('Parsed JSON data:', parsedData);

          // Check for empty rows which can cause errors
          if (!parsedData.table.rows || parsedData.table.rows.length === 0) {
            return [];
          }

          const rows = parsedData.table.rows;
          const cols = parsedData.table.cols;

          // Convert the rows into an array of objects with correct keys
          const formattedData = rows.map(row => {
            const obj = {};
            row.c.forEach((cell, index) => {
              const key = cols[index]?.label;
              if (key) {
                obj[key] = cell && cell.v !== null ? cell.v : null;
              }
            });
            return obj;
          });
          console.log('Formatted Data:', formattedData);

          return formattedData;
        } catch (err) {
          console.error(`Error fetching or parsing data from URL: ${url}`, err);
          throw new Error(`Failed to process data from ${url}. Details: ${err.message}`);
        }
      };

      // Main App component for the dashboard
      function App() {
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);

        useEffect(() => {
          const fetchData = async () => {
            try {
              setLoading(true);
              setError(null);

              // Check if the placeholder URLs are still in the code.
              if (summaryUrl.includes('65ythg65ythg65ythg')) {
                setError("Please replace the placeholder URLs in the code with your actual Google Sheet JSON URLs.");
                setLoading(false);
                return;
              }

              // Fetch and parse data from all four endpoints concurrently.
              const [summaryData, weeklySalesData, demoTrendsData, pipelineData] = await Promise.all([
                fetchAndParseSheetData(summaryUrl),
                fetchAndParseSheetData(weeklySalesUrl),
                fetchAndParseSheetData(demoTrendsUrl),
                fetchAndParseSheetData(pipelineUrl),
              ]);

              // --- Data Validation and Logging ---
              // Log the fetched data to help with debugging
              console.log('Fetched Summary Data:', summaryData);
              console.log('Fetched Weekly Sales Data:', weeklySalesData);
              console.log('Fetched Demo Trends Data:', demoTrendsData);
              console.log('Fetched Pipeline Data:', pipelineData);
              
              // Validate that the required data structures are not empty
              if (!summaryData || summaryData.length === 0) {
                throw new Error(`Data for Summary dashboard is empty. Please check your published sheet. Url: ${summaryUrl}`);
              }
              if (!weeklySalesData || weeklySalesData.length === 0) {
                throw new Error(`Data for Weekly Sales chart is empty. Please check your published sheet. Url: ${weeklySalesUrl}`);
              }
              if (!demoTrendsData || demoTrendsData.length === 0) {
                throw new Error(`Data for Demo Trends chart is empty. Please check your published sheet. Url: ${demoTrendsUrl}`);
              }
              if (!pipelineData || pipelineData.length === 0) {
                throw new Error(`Data for Pipeline Breakdown chart is empty. Please check your published sheet. Url: ${pipelineUrl}`);
              }

              // Structure the fetched data into a single object for the dashboard's state.
              const structuredData = {
                summary: {
                  totalSales: summaryData.find(item => item.metric === 'Total Sales')?.value || 0,
                  totalRevenue: summaryData.find(item => item.metric === 'Total Revenue')?.value || 0,
                  demosBooked: summaryData.find(item => item.metric === 'Demos Booked')?.value || 0,
                  conversionRate: summaryData.find(item => item.metric === 'Conversion Rate')?.value || 0,
                  pipelineValue: summaryData.find(item => item.metric === 'Pipeline Value')?.value || 0,
                },
                weeklySales: weeklySalesData,
                demoTrends: demoTrendsData,
                pipelineBreakdown: pipelineData.map(item => ({
                  ...item,
                  color: item.name === 'New Opportunities' ? '#0EA5E9' :
                         item.name === 'Active Opportunities' ? '#3B82F6' :
                         item.name === 'Closed-Won' ? '#22C55E' :
                         '#EF4444',
                })),
              };

              setData(structuredData);
            } catch (err) {
              setError(`Failed to load dashboard. The page is blank due to a data-related issue. Details: ${err.message}`);
              console.error('Dashboard Load Error:', err);
            } finally {
              setLoading(false);
            }
          };

          fetchData();
        }, []); // The empty array ensures this effect runs only once on mount

        // Handle loading and error states for a better user experience
        if (loading) {
          return (
            <div className="flex items-center justify-center min-h-screen font-inter text-gray-700">
              <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Loading dashboard data...
            </div>
          );
        }

        if (error) {
          return (
            <div className="flex flex-col items-center justify-center min-h-screen font-inter text-red-600 p-4 sm:p-8">
              <h1 className="text-2xl font-bold mb-4">Error Loading Dashboard</h1>
              <p className="text-center">{error}</p>
            </div>
          );
        }

        if (!data) {
          return <div className="text-center p-8 text-gray-500">No data available to display. Please check the source.</div>;
        }
        
        // Calculate the total for the pie chart tooltip
        const totalPipeline = data.pipelineBreakdown.reduce((sum, entry) => sum + entry.value, 0);

        return (
          <div className="bg-slate-100 min-h-screen p-4 sm:p-8 font-inter">
            <div className="max-w-7xl mx-auto">
              {/* Dashboard Header */}
              <header className="mb-8">
                <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">
                  Weekly Sales Dashboard
                </h1>
                <p className="text-lg text-gray-600">
                  A visual overview of our team's performance and pipeline health.
                </p>
              </header>

              {/* Key Metrics Section */}
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                {/* Total Sales Card */}
                <div className="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center text-center transition-transform hover:scale-105">
                  <p className="text-lg text-gray-500 font-medium">Total Sales</p>
                  <p className="text-4xl font-bold text-blue-600">${data.summary.totalSales.toLocaleString()}</p>
                </div>

                {/* Total Revenue Card */}
                <div className="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center text-center transition-transform hover:scale-105">
                  <p className="text-lg text-gray-500 font-medium">Total Revenue</p>
                  <p className="text-4xl font-bold text-green-600">${data.summary.totalRevenue.toLocaleString()}</p>
                </div>
                
                {/* Demos Booked Card */}
                <div className="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center text-center transition-transform hover:scale-105">
                  <p className="text-lg text-gray-500 font-medium">Demos Booked</p>
                  <p className="text-4xl font-bold text-yellow-600">{data.summary.demosBooked}</p>
                </div>

                {/* Conversion Rate Card */}
                <div className="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center text-center transition-transform hover:scale-105">
                  <p className="text-lg text-gray-500 font-medium">Conversion Rate</p>
                  <p className="text-4xl font-bold text-purple-600">{(data.summary.conversionRate * 100).toFixed(1)}%</p>
                </div>
              </div>
              
              {/* Charts Section */}
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Weekly Sales Chart */}
                <div className="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-2xl font-bold text-gray-800 mb-4">Weekly Sales & Revenue</h2>
                  <ResponsiveContainer width="100%" height={300}>
                    <BarChart
                      data={data.weeklySales}
                      margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis yAxisId="left" orientation="left" stroke="#8884d8" />
                      <YAxis yAxisId="right" orientation="right" stroke="#82ca9d" />
                      <Tooltip />
                      <Legend />
                      <Bar yAxisId="left" dataKey="sales" fill="#8884d8" name="Sales" />
                      <Bar yAxisId="right" dataKey="revenue" fill="#82ca9d" name="Revenue" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>

                {/* Pipeline Breakdown Chart */}
                <div className="lg:col-span-1 bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
                  <h2 className="text-2xl font-bold text-gray-800 mb-4 text-center">Pipeline Breakdown</h2>
                  <ResponsiveContainer width="100%" height={300}>
                    <PieChart>
                      <Pie
                        data={data.pipelineBreakdown}
                        cx="50%"
                        cy="50%"
                        outerRadius={100}
                        dataKey="value"
                        nameKey="name"
                      >
                        {data.pipelineBreakdown.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.color} />
                        ))}
                      </Pie>
                      <Tooltip formatter={(value, name) => [`${((value / totalPipeline) * 100).toFixed(1)}%`, name]} />
                      <Legend />
                    </PieChart>
                  </ResponsiveContainer>
                </div>

                {/* Demo Trends Line Chart */}
                <div className="lg:col-span-3 bg-white rounded-xl shadow-lg p-6 mt-6">
                  <h2 className="text-2xl font-bold text-gray-800 mb-4">Demo Trends</h2>
                  <ResponsiveContainer width="100%" height={300}>
                    <LineChart
                      data={data.demoTrends}
                      margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="week" />
                      <YAxis />
                      <Tooltip />
                      <Legend />
                      <Line type="monotone" dataKey="demos" stroke="#8B5CF6" activeDot={{ r: 8 }} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>
          </div>
        );
      }
      
      // Render the app to the root div
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    });
  </script>
</body>
</html>